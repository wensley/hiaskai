name: Release Desktop Canary

# ============================================
# Canary è‡ªåŠ¨å‘ç‰ˆå·¥ä½œæµ
# ============================================
# è§¦å‘æ¡ä»¶:
#   1. canary åˆ†æ”¯æœ‰ push (åˆå…¥ PR) ä¸” commit å‰ç¼€ä¸º style/feat/fix/refactor/release (æ”¯æŒ gitmoji)
#   2. æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
#
# å¹¶å‘ç­–ç•¥:
#   åŒä¸€ workflow ä»…ä¿ç•™æœ€æ–°ä¸€æ¬¡è¿è¡Œï¼Œè‡ªåŠ¨å–æ¶ˆæ’é˜Ÿä¸­çš„æ—§ build
#
# ç‰ˆæœ¬ç­–ç•¥:
#   åŸºäºæœ€æ–° stable tag çš„ patch+1, postfix ä¸ºé€’å¢åºå·
#   æ ¼å¼: X.Y.(Z+1)-canary.N
#   ä¾‹: å½“å‰ tag v2.1.28 â†’ v2.1.29-canary.1, ä¸‹æ¬¡ â†’ v2.1.29-canary.2
# ============================================

on:
  push:
    branches:
      - canary
  workflow_dispatch:
    inputs:
      force:
        description: 'Force build (skip commit message check)'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

permissions: read-all

env:
  NODE_VERSION: '24.11.1'

jobs:
  # ============================================
  # æ£€æŸ¥ commit å‰ç¼€å¹¶è®¡ç®—ç‰ˆæœ¬å·
  # ============================================
  calculate-version:
    name: Calculate Canary Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check commit message prefix
        id: check
        run: |
          # æ‰‹åŠ¨è§¦å‘ + force æ—¶è·³è¿‡æ£€æŸ¥
          if [ "${{ inputs.force }}" == "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "ğŸ”§ Force build requested, skipping commit check"
            exit 0
          fi

          # æ‰‹åŠ¨è§¦å‘ (æ—  force) ä¹Ÿç›´æ¥æ„å»º
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "ğŸ”§ Manual trigger, proceeding with build"
            exit 0
          fi

          # è·å–æœ¬æ¬¡ push çš„ head commit message
          commit_msg=$(git log -1 --pretty=%s HEAD)
          echo "ğŸ“ Head commit: $commit_msg"

          # æ£€æŸ¥æ˜¯å¦åŒ¹é… style/feat/fix/refactor/release å‰ç¼€ (æ”¯æŒ gitmoji å‰ç¼€)
          if echo "$commit_msg" | grep -qiE '^(ğŸ’„\s*)?style(\(.+\))?:|^(âœ¨\s*)?feat(\(.+\))?:|^(ğŸ›\s*)?fix(\(.+\))?:|^(â™»ï¸\s*)?refactor(\(.+\))?:|^(ğŸš€\s*)?release(\(.+\))?:'; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "âœ… Commit matches canary build trigger: $commit_msg"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Commit does not match style/feat/fix/refactor/release prefix, skipping: $commit_msg"
          fi

      - name: Calculate canary version
        if: steps.check.outputs.should_build == 'true'
        id: version
        run: |
          # è·å–æœ€æ–°çš„ stable tag (æ’é™¤ nightly/canary/beta ç­‰)
          latest_tag=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)

          if [ -z "$latest_tag" ]; then
            echo "âŒ No stable tag found"
            exit 1
          fi

          echo "ğŸ“Œ Latest stable tag: $latest_tag"

          # å»æ‰ v å‰ç¼€ï¼Œè§£æ major.minor.patch â†’ a.b.c å– c+1
          base_version="${latest_tag#v}"
          IFS='.' read -r major minor patch <<< "$base_version"
          new_patch=$((patch + 1))
          base_canary="${major}.${minor}.${new_patch}"

          # postfix: åŒ base ä¸‹å·²æœ‰ canary æ ‡ç­¾çš„æœ€å¤§åºå· + 1
          max_seq=0
          for t in $(git tag -l "v${base_canary}-canary.*" 2>/dev/null || true); do
            seq=$(echo "$t" | grep -oE '[0-9]+$' || true)
            if [ -n "$seq" ] && [ "$seq" -gt "$max_seq" ] 2>/dev/null; then
              max_seq=$seq
            fi
          done
          next_seq=$((max_seq + 1))

          version="${base_canary}-canary.${next_seq}"
          tag="v${version}"

          echo "version=${version}" >> $GITHUB_OUTPUT
          echo "tag=${tag}" >> $GITHUB_OUTPUT
          echo "âœ… Canary version: ${version}"
          echo "ğŸ·ï¸ Tag: ${tag}"

  # ============================================
  # ä»£ç è´¨é‡æ£€æŸ¥
  # ============================================
  test:
    name: Code quality check
    needs: [calculate-version]
    if: needs.calculate-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          package-manager-cache: false

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install deps
        run: bun i

      - name: Lint
        run: bun run lint

  # ============================================
  # å¤šå¹³å°æ„å»º
  # ============================================
  build:
    needs: [calculate-version, test]
    if: needs.calculate-version.outputs.should_build == 'true'
    name: Build Desktop App
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-15, macos-15-intel, windows-2025, ubuntu-latest]
    steps:
      - uses: actions/checkout@v6

      - name: Setup build environment
        uses: ./.github/actions/desktop-build-setup
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set package version
        run: npm run workflow:set-desktop-version ${{ needs.calculate-version.outputs.version }} canary

      # macOS æ„å»ºå‰æ¸…ç† (ä¿®å¤ hdiutil é—®é¢˜)
      - name: Clean previous build artifacts (macOS)
        if: runner.os == 'macOS'
        run: |
          sudo rm -rf apps/desktop/release || true
          sudo rm -rf apps/desktop/dist || true
          sudo rm -rf /tmp/electron-builder* || true

      # macOS æ„å»º
      - name: Build artifact on macOS
        if: runner.os == 'macOS'
        run: npm run desktop:package:app
        env:
          UPDATE_CHANNEL: canary
          APP_URL: http://localhost:3015
          DATABASE_URL: 'postgresql://postgres@localhost:5432/postgres'
          KEY_VAULTS_SECRET: 'oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE='
          CSC_LINK: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CSC_KEY_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          CSC_FOR_PULL_REQUEST: true
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_BETA_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_BETA_DESKTOP_BASE_URL }}

      # Windows æ„å»º
      - name: Build artifact on Windows
        if: runner.os == 'Windows'
        run: npm run desktop:package:app
        env:
          UPDATE_CHANNEL: canary
          APP_URL: http://localhost:3015
          DATABASE_URL: 'postgresql://postgres@localhost:5432/postgres'
          KEY_VAULTS_SECRET: 'oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE='
          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_BETA_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_BETA_DESKTOP_BASE_URL }}
          TEMP: C:\temp
          TMP: C:\temp

      # Linux æ„å»º
      - name: Build artifact on Linux
        if: runner.os == 'Linux'
        run: npm run desktop:package:app
        env:
          UPDATE_CHANNEL: canary
          APP_URL: http://localhost:3015
          DATABASE_URL: 'postgresql://postgres@localhost:5432/postgres'
          KEY_VAULTS_SECRET: 'oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE='
          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_BETA_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_BETA_DESKTOP_BASE_URL }}

      - name: Upload artifacts
        uses: ./.github/actions/desktop-upload-artifacts
        with:
          artifact-name: release-${{ matrix.os }}
          retention-days: 3

  # ============================================
  # åˆå¹¶ macOS å¤šæ¶æ„ latest-mac.yml æ–‡ä»¶
  # ============================================
  merge-mac-files:
    needs: [build]
    name: Merge macOS Release Files
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          package-manager-cache: false

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: release
          pattern: release-*
          merge-multiple: true

      - name: List downloaded artifacts
        run: ls -R release

      - name: Install yaml only for merge step
        run: |
          cd scripts/electronWorkflow
          if [ ! -f package.json ]; then
            echo '{"name":"merge-mac-release","private":true}' > package.json
          fi
          bun add --no-save yaml@2.8.1

      - name: Merge latest-mac.yml files
        run: bun run scripts/electronWorkflow/mergeMacReleaseFiles.js

      - name: Upload artifacts with merged macOS files
        uses: actions/upload-artifact@v6
        with:
          name: merged-release
          path: release/
          retention-days: 1

  # ============================================
  # åˆ›å»º Canary Release
  # ============================================
  publish-release:
    needs: [merge-mac-files, calculate-version]
    name: Publish Canary Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download merged artifacts
        uses: actions/download-artifact@v7
        with:
          name: merged-release
          path: release

      - name: List final artifacts
        run: ls -R release

      - name: Create Canary Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.calculate-version.outputs.tag }}
          name: 'Desktop Canary ${{ needs.calculate-version.outputs.tag }}'
          prerelease: true
          body: |
            ## ğŸ¤ Canary Build â€” ${{ needs.calculate-version.outputs.tag }}

            > Automated canary build from `canary` branch.

            ### âš ï¸ Important Notes

            - **This is an automated canary build and is NOT intended for production use.**
            - Canary builds are triggered by `build`/`fix`/`style` commits on the `canary` branch.
            - May contain **unstable or incomplete changes**. **Use at your own risk.**
            - It is strongly recommended to **back up your data** before using a canary build.

            ### ğŸ“¦ Installation

            Download the appropriate installer for your platform from the assets below.

            | Platform | File |
            |----------|------|
            | macOS (Apple Silicon) | `.dmg` (arm64) |
            | macOS (Intel) | `.dmg` (x64) |
            | Windows | `.exe` |
            | Linux | `.AppImage` / `.deb` |
          files: |
            release/latest*
            release/*.dmg*
            release/*.zip*
            release/*.exe*
            release/*.AppImage
            release/*.deb*
            release/*.snap*
            release/*.rpm*
            release/*.tar.gz*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # æ¸…ç†æ—§çš„ Canary Releases (ä¿ç•™æœ€è¿‘ 7 ä¸ª)
  # ============================================
  cleanup-old-canaries:
    needs: [publish-release]
    name: Cleanup Old Canary Releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Delete old canary releases
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            });

            const canaryReleases = releases
              .filter(r => r.tag_name.includes('-canary.'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            const toDelete = canaryReleases.slice(7);

            for (const release of toDelete) {
              console.log(`ğŸ—‘ï¸ Deleting old canary release: ${release.tag_name}`);

              // Delete the release
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
              });

              // Delete the tag
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `tags/${release.tag_name}`,
                });
              } catch (e) {
                console.log(`âš ï¸ Could not delete tag ${release.tag_name}: ${e.message}`);
              }
            }

            console.log(`âœ… Cleanup complete. Kept ${Math.min(canaryReleases.length, 7)} canary releases, deleted ${toDelete.length}.`);
